<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç–²å‹åµæ¸¬ | HRV é›²ç«¯æ•¸æ“šä¸­å¿ƒ</title>
    
    <!-- å¼•å…¥å¿…è¦çš„å¤–éƒ¨å‡½å¼åº« (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* å­—å‹è¨­å®š */
        @import url('https://fonts.googleapis.com/css2?family=Urbanist:wght@400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        :root {
            --color-bg: #0f172a;
            --color-panel: #1e293b;
            --color-accent: #6366f1;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-bg);
            color: #f8fafc;
        }

        .font-display { font-family: 'Urbanist', sans-serif; }

        /* ç»ç’ƒæ“¬æ…‹æ•ˆæœ */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* æª”æ¡ˆæ‹–æ›³å€ */
        .file-drop-zone {
            border: 2px dashed #475569;
            transition: all 0.3s ease;
        }
        .file-drop-zone:hover, .file-drop-zone.dragover {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        /* åœ–è¡¨å€èƒŒæ™¯ */
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
            background-color: #1e293b; 
            border-radius: 12px;
            padding: 10px;
        }

        /* èŠå¤©å®¤å‹•ç•« */
        .chat-msg { animation: fadeIn 0.3s ease-out; }
        .chat-bubble-ai {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px 12px 12px 2px;
        }
        .chat-bubble-user {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px 12px 2px 12px;
        }

        /* éŸ³è¨Šæ³¢å½¢å‹•ç•« */
        .audio-bar {
            width: 4px; height: 10px; background-color: #a855f7; border-radius: 2px;
            animation: audioWave 1s infinite ease-in-out;
        }
        .audio-bar:nth-child(2) { animation-delay: 0.1s; height: 15px; }
        .audio-bar:nth-child(3) { animation-delay: 0.2s; height: 20px; }
        .audio-bar:nth-child(4) { animation-delay: 0.3s; height: 12px; }
        @keyframes audioWave { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.5); } }

        /* é€šç”¨å‹•ç•« */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .pulse-live { animation: pulseLive 2s infinite; }
        @keyframes pulseLive { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- é ‚éƒ¨å°èˆªåˆ— -->
    <header class="border-b border-white/10 bg-slate-900/50 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <!-- LOGO -->
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center text-white font-bold text-xl">F</div>
                <div>
                    <h1 class="font-display font-bold text-lg leading-tight">ç–²å‹åµæ¸¬ç³»çµ±</h1>
                    <p class="text-xs text-slate-400">HRV æ•¸æ“šåˆ†æä¸­å¿ƒ</p>
                </div>
            </div>
            <!-- é€£ç·šç‹€æ…‹èˆ‡æŒ‰éˆ• -->
            <div class="flex items-center gap-4">
                <div id="connection-status" class="text-xs font-bold text-red-400 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-red-500"></span> è£ç½®æœªé€£æ¥
                </div>
                <button onclick="connectSerial()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition-all shadow-lg shadow-blue-500/20 flex items-center gap-2">
                    <i class="fa-brands fa-usb"></i> é€£æ¥ Arduino
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="container mx-auto px-6 py-8 flex-1">
        <div class="grid lg:grid-cols-12 gap-8">
            
            <!-- å·¦æ¬„ (4æ¬„å¯¬) -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- 1. å³æ™‚æ•¸æ“šé¢æ¿ (é€£ç·šå¾Œé¡¯ç¤º) -->
                <div class="glass p-6 rounded-2xl border-l-4 border-green-500 hidden" id="live-panel">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-heart-pulse text-green-400 pulse-live"></i> å³æ™‚æ•¸æ“š
                        </h2>
                        <span class="text-[10px] bg-green-500/20 text-green-400 px-2 py-1 rounded font-mono">LIVE</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-800/80 p-3 rounded-xl text-center">
                            <div class="text-xs text-slate-400 mb-1">BPM (å¿ƒç‡)</div>
                            <div id="live-bpm" class="text-3xl font-bold text-white font-display">--</div>
                        </div>
                        <div class="bg-slate-800/80 p-3 rounded-xl text-center">
                            <div class="text-xs text-slate-400 mb-1">HRV (è®Šç•°)</div>
                            <div id="live-hrv" class="text-3xl font-bold text-blue-400 font-display">--</div>
                        </div>
                    </div>
                    <div id="live-message" class="mt-4 text-xs text-center text-slate-400 font-mono bg-slate-900/50 p-2 rounded">
                        ç­‰å¾…è¨Šè™Ÿä¸­...
                    </div>
                </div>

                <!-- 2. æ•¸æ“šè¼¸å…¥å¡ç‰‡ -->
                <div class="glass p-6 rounded-2xl">
                    <h2 class="font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-cloud-arrow-up text-blue-400"></i> æ•¸æ“šè¼¸å…¥
                    </h2>
                    
                    <!-- æ‹–æ›³å€ -->
                    <div id="drop-zone" class="file-drop-zone rounded-xl p-8 text-center cursor-pointer mb-4">
                        <i class="fa-solid fa-file-csv text-3xl text-slate-500 mb-2"></i>
                        <p class="text-sm text-slate-300 font-medium">æ‹–æ›³ .txt / .csv è‡³æ­¤</p>
                        <input type="file" id="file-input" class="hidden" accept=".txt,.csv">
                    </div>

                    <!-- æ‰‹å‹•è¼¸å…¥å€ -->
                    <div class="mb-4">
                        <textarea id="manual-input" class="w-full bg-slate-800/50 border border-slate-700 rounded-lg p-3 text-xs font-mono text-slate-300 focus:border-blue-500 focus:outline-none resize-none h-24" placeholder="æˆ–è²¼ä¸Šæ•¸æ“šåºåˆ—: 100, 95, 80..."></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="simulateData()" class="py-2 px-4 rounded-lg border border-slate-600 text-slate-300 text-sm font-bold hover:bg-slate-700 transition-all">
                            <i class="fa-solid fa-dice"></i> æ¨¡æ“¬æ•¸æ“š
                        </button>
                        <button onclick="processData()" class="py-2 px-4 rounded-lg bg-blue-600 text-white text-sm font-bold hover:bg-blue-500 transition-all shadow-lg shadow-blue-500/20">
                            <i class="fa-solid fa-chart-line"></i> ç”Ÿæˆåœ–è¡¨
                        </button>
                    </div>
                </div>

                <!-- 3. çµ±è¨ˆæ‘˜è¦ -->
                <div id="stats-card" class="glass p-6 rounded-2xl hidden fade-in">
                    <h3 class="font-bold text-white mb-4 text-sm uppercase tracking-wider">æ•¸æ“šæ‘˜è¦</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700"><div class="text-xs text-slate-400">å¹³å‡ HRV</div><div id="stat-avg" class="text-xl font-bold text-white font-mono">--</div></div>
                        <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700"><div class="text-xs text-slate-400">æœ€ä½ HRV</div><div id="stat-min" class="text-xl font-bold text-red-400 font-mono">--</div></div>
                        <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700"><div class="text-xs text-slate-400">ç–²å‹æ¬¡æ•¸</div><div id="stat-fatigue" class="text-xl font-bold text-blue-400 font-mono">--</div></div>
                        <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700"><div class="text-xs text-slate-400">è³‡æ–™é»æ•¸</div><div id="stat-time" class="text-xl font-bold text-slate-300 font-mono">--</div></div>
                    </div>
                </div>
            </div>

            <!-- å³æ¬„ (8æ¬„å¯¬) -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- 4. åœ–è¡¨é¡¯ç¤ºå€ -->
                <div class="glass p-6 rounded-2xl border border-slate-700">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-bold text-white text-lg">HRV è¶¨å‹¢åˆ†æåœ–</h2>
                        <div class="flex gap-2">
                            <!-- åŒ¯å‡ºåŠŸèƒ½ -->
                            <button onclick="downloadChartImage()" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold flex items-center gap-2 transition-all">
                                <i class="fa-solid fa-camera"></i> ä¸‹è¼‰åœ–ç‰‡
                            </button>
                            <button onclick="downloadCSV()" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold flex items-center gap-2 transition-all">
                                <i class="fa-solid fa-file-export"></i> åŒ¯å‡º CSV
                            </button>
                        </div>
                    </div>
                    <div class="chart-container" id="chart-wrapper">
                        <canvas id="hrvChart"></canvas>
                    </div>
                    <div class="flex gap-4 text-xs font-bold mt-4 justify-center">
                        <span class="flex items-center gap-1 text-green-400"><span class="w-2 h-2 rounded-full bg-green-500"></span> æ­£å¸¸ (>80)</span>
                        <span class="flex items-center gap-1 text-red-400"><span class="w-2 h-2 rounded-full bg-red-500"></span> ç–²å‹/å£“åŠ› (<80)</span>
                    </div>
                </div>

                <!-- 5. AI å¥åº·é¡§å• (èŠå¤©å®¤) -->
                <div id="ai-card" class="glass p-1 rounded-2xl bg-gradient-to-r from-purple-500/20 to-blue-500/20 border border-purple-500/30 hidden fade-in">
                    <div class="bg-slate-900/90 rounded-xl h-full flex flex-col">
                        <div class="p-6 border-b border-white/5 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-purple-500 flex items-center justify-center text-white"><i class="fa-solid fa-robot"></i></div>
                                <div>
                                    <h3 class="font-bold text-white">Gemini å¥åº·é¡§å•</h3>
                                    <div class="flex items-center gap-2 text-xs text-purple-300"><span><i class="fa-solid fa-volume-high"></i> æ”¯æ´èªéŸ³å°è©±</span></div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="generateVoiceAdvice()" id="btn-voice-advice" class="px-3 py-1.5 rounded-full bg-purple-600/20 text-purple-300 text-xs font-bold hover:bg-purple-600 hover:text-white border border-purple-500/30 transition-all flex items-center gap-2">
                                    <i class="fa-solid fa-play"></i> èªéŸ³å»ºè­°
                                </button>
                                <button onclick="downloadReport()" class="px-3 py-1.5 rounded-full bg-green-600/20 text-green-400 text-xs font-bold hover:bg-green-600 hover:text-white border border-green-500/30 transition-all flex items-center gap-2">
                                    <i class="fa-solid fa-file-arrow-down"></i> ä¸‹è¼‰å ±å‘Š
                                </button>
                            </div>
                        </div>
                        
                        <!-- è¨Šæ¯åˆ—è¡¨ -->
                        <div id="chat-history" class="p-6 space-y-4 max-h-[300px] overflow-y-auto text-sm text-slate-300">
                            <div class="chat-msg flex gap-3">
                                <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 shrink-0 text-xs"><i class="fa-solid fa-robot"></i></div>
                                <div class="chat-bubble-ai p-3"><p>ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ HRV å¥åº·é¡§å•ã€‚æˆ‘å¯ä»¥å¹«ä½ åˆ†æç–²å‹æ•¸æ“šä¸¦æä¾›å»ºè­°ã€‚</p></div>
                            </div>
                            <div id="ai-report-container" class="hidden">
                                <div class="chat-msg flex gap-3">
                                    <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 shrink-0 text-xs"><i class="fa-solid fa-file-medical"></i></div>
                                    <div class="chat-bubble-ai p-3 w-full"><div id="ai-content" class="leading-relaxed"></div></div>
                                </div>
                            </div>
                        </div>

                        <!-- èªéŸ³æ’­æ”¾å™¨ -->
                        <div id="audio-container" class="px-6 py-2 hidden">
                            <div class="flex items-center gap-3 bg-purple-500/10 rounded-lg p-3 border border-purple-500/20">
                                <div class="flex gap-1 h-4 items-end"><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div></div>
                                <span class="text-xs text-purple-300 font-mono">Gemini èªéŸ³æ’­æ”¾ä¸­...</span>
                            </div>
                        </div>

                        <!-- è¼¸å…¥æ¡† -->
                        <div class="p-4 border-t border-white/5 bg-slate-800/30 rounded-b-xl">
                            <div class="flex gap-2">
                                <input type="text" id="chat-input" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-sm text-white focus:border-purple-500 focus:outline-none" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="handleKeyPress(event)">
                                <button onclick="askGemini()" id="btn-send" class="bg-purple-600 hover:bg-purple-500 text-white w-10 h-10 rounded-lg flex items-center justify-center transition-all"><i class="fa-solid fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript é‚è¼¯æ§åˆ¶ -->
    <script>
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        // â˜…ã€è«‹åœ¨é€™è£¡å¡«å…¥æ‚¨çš„ Gemini API Keyã€‘â˜…
        // ç¯„ä¾‹ï¼šconst apiKey = "AIzaSyDxxxxxxxxx...";
        const apiKey = "AIzaSyB6fJGENEUzDVaHbKYYrd4BfxyBBJ3kxc4"; 
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        function checkApiKey() {
            // å¦‚æœ Key æ˜¯ç©ºçš„ï¼Œæˆ–æ˜¯é è¨­æ–‡å­—ï¼Œå°±è·³å‡ºè­¦å‘Š
            if (!apiKey || apiKey === "åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„_API_KEY") {
                const manualKey = prompt("ç¨‹å¼ç¢¼ä¸­å°šæœªå¡«å…¥ API Keyï¼\n\næ‚¨å¯ä»¥ï¼š\n1. æŒ‰ä¸‹ç¢ºå®šï¼Œæš«æ™‚è¼¸å…¥ Key ä¾†ä½¿ç”¨\n2. æŒ‰ä¸‹å–æ¶ˆï¼Œå»ä¿®æ”¹ç¨‹å¼ç¢¼ç¬¬ 390 è¡Œç›´æ¥å¯«æ­»");
                if (manualKey) {
                    return manualKey; 
                }
                return false;
            }
            return apiKey;
        }

        // --- Chart.js è¨­å®š ---
        let hrvChart;
        const ctx = document.getElementById('hrvChart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)'); 
        gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)'); 

        hrvChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'HRV (ms)',
                    data: [],
                    borderColor: '#6366f1',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3,
                    pointBackgroundColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' }, suggestedMax: 150 },
                    x: { grid: { display: false }, ticks: { display: false } }
                }
            }
        });

        // --- æ ¸å¿ƒè®Šæ•¸ ---
        let currentData = [];

        // --- æ•¸æ“šè™•ç† ---
        function processData() {
            const rawText = document.getElementById('manual-input').value;
            const dataPoints = rawText.trim() ? rawText.split(/[\s,]+/).map(Number).filter(n => !isNaN(n) && n > 0) : [];
            currentData = dataPoints;
            if (dataPoints.length > 0) {
                updateChart(dataPoints);
                calculateStats(dataPoints);
                document.getElementById('stats-card').classList.remove('hidden');
                document.getElementById('ai-card').classList.remove('hidden');
                if(document.getElementById('ai-content').innerHTML === "") {
                    analyzeWithAI();
                }
            }
        }

        function updateChart(data) {
            const labels = data.map((_, i) => `T${i}`);
            const viewData = data.slice(-50); 
            const viewLabels = labels.slice(-50);
            hrvChart.data.labels = viewLabels;
            hrvChart.data.datasets[0].data = viewData;
            const pointColors = viewData.map(v => v < 80 ? '#ef4444' : '#fff');
            hrvChart.data.datasets[0].pointBackgroundColor = pointColors;
            hrvChart.data.datasets[0].pointBorderColor = pointColors;
            hrvChart.update();
        }

        function calculateStats(data) {
            if (data.length === 0) return;
            const avg = Math.round(data.reduce((a, b) => a + b, 0) / data.length);
            const min = Math.min(...data);
            const fatigueCount = data.filter(v => v < 80).length;
            document.getElementById('stat-avg').innerText = avg + " ms";
            document.getElementById('stat-min').innerText = min + " ms";
            document.getElementById('stat-fatigue').innerText = fatigueCount + " æ¬¡";
            document.getElementById('stat-time').innerText = data.length;
        }

        function simulateData() {
            let data = [];
            let val = 100;
            for(let i=0; i<50; i++) {
                val += (Math.random() * 20 - 10);
                if(i > 20 && i < 35) val -= 5;
                if(i > 35) val += 5;
                if(val > 150) val = 150;
                if(val < 30) val = 30;
                data.push(Math.round(val));
            }
            document.getElementById('manual-input').value = data.join(', ');
            processData();
        }

        // --- AI èŠå¤© ---
        function handleKeyPress(e) { if (e.key === 'Enter') askGemini(); }

        async function askGemini() {
            const inputEl = document.getElementById('chat-input');
            const question = inputEl.value.trim();
            if (!question) return;
            
            const currentKey = checkApiKey();
            if (!currentKey) return;

            addChatMessage(question, 'user');
            inputEl.value = '';
            const loadingId = addChatMessage("æ€è€ƒä¸­...", 'ai', true);

            try {
                const dataStr = currentData.slice(-20).join(', ');
                const prompt = `Role: Health Consultant. Data: [${dataStr}]. User: "${question}". Answer in Traditional Chinese.`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                const text = data.candidates[0].content.parts[0].text;
                document.getElementById(loadingId).remove();
                addChatMessage(marked.parse(text), 'ai');
            } catch (e) {
                console.error(e);
                document.getElementById(loadingId).remove();
                addChatMessage(`éŒ¯èª¤: ${e.message}`, 'ai');
            }
        }

        async function analyzeWithAI() {
            if (currentData.length === 0) return;
            const currentKey = checkApiKey();
            if (!currentKey) return;

            document.getElementById('ai-report-container').classList.remove('hidden');
            const content = document.getElementById('ai-content');
            content.innerHTML = '<div class="flex gap-2"><div class="typing-dot w-2 h-2 bg-purple-400 rounded-full"></div><div class="typing-dot w-2 h-2 bg-purple-400 rounded-full"></div></div>';

            try {
                const dataStr = currentData.join(', ');
                const prompt = `Act as Health Analyst. Analyze HRV data: [${dataStr}]. Context: Low < 80 Stress/Fatigue. Identify trends & give 1 advice. Output: Traditional Chinese Markdown.`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                content.innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
            } catch (e) { content.innerHTML = `<span class="text-red-400">åˆ†æå¤±æ•—: ${e.message}</span>`; }
        }

        function addChatMessage(htmlContent, sender, isLoading = false) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `chat-msg flex gap-3 ${sender === 'user' ? 'justify-end' : ''}`;
            div.id = 'msg-' + Date.now();
            div.innerHTML = sender === 'ai' ? 
                `<div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 shrink-0 text-xs"><i class="fa-solid fa-robot"></i></div><div class="chat-bubble-ai p-3 text-slate-200">${isLoading ? '<div class="flex gap-1"><div class="typing-dot w-1 bg-purple-400 h-1 rounded-full"></div></div>' : htmlContent}</div>` : 
                `<div class="chat-bubble-user p-3 text-white bg-blue-600/50 border border-blue-500/30"><p>${htmlContent}</p></div><div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 shrink-0 text-xs"><i class="fa-solid fa-user"></i></div>`;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            return div.id;
        }

        // --- TTS ---
        async function generateVoiceAdvice() {
            if (currentData.length === 0) return alert("è«‹å…ˆè¼‰å…¥æ•¸æ“š");
            const currentKey = checkApiKey();
            if (!currentKey) return;

            const btn = document.getElementById('btn-voice-advice');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...'; btn.disabled = true;
            try {
                // 1. Text Gen
                const dataStr = currentData.slice(-10).join(', ');
                const textPrompt = `Act as a caring coach. Based on HRV readings [${dataStr}] (Low < 80 = tired), write a ONE-SENTENCE encouraging message in Traditional Chinese to be spoken.`;
                const textResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: textPrompt }] }] })
                });
                const textData = await textResp.json();
                if(textData.error) throw new Error(textData.error.message);
                const script = textData.candidates[0].content.parts[0].text.trim();

                // 2. Audio Gen
                const ttsResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: script }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } } } })
                });
                const ttsData = await ttsResp.json();
                if(ttsData.error) throw new Error(ttsData.error.message);
                const audioContent = ttsData.candidates[0].content.parts[0].inlineData.data;

                // 3. Play
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const arrayBuffer = Uint8Array.from(atob(audioContent), c => c.charCodeAt(0)).buffer;
                const pcmData = new Int16Array(arrayBuffer);
                const floatBuffer = new Float32Array(pcmData.length);
                for (let i = 0; i < pcmData.length; i++) floatBuffer[i] = pcmData[i] / 32768.0;
                const audioBuffer = audioCtx.createBuffer(1, floatBuffer.length, 24000);
                audioBuffer.getChannelData(0).set(floatBuffer);
                const source = audioCtx.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioCtx.destination);
                source.start(0);
                
                document.getElementById('audio-container').classList.remove('hidden');
                addChatMessage(`ğŸ”Š æ’­æ”¾èªéŸ³ï¼šã€Œ${script}ã€`, 'ai');
                source.onended = () => { document.getElementById('audio-container').classList.add('hidden'); btn.disabled = false; btn.innerHTML = originalText; };
            } catch (e) { 
                console.error(e); alert("èªéŸ³ç”Ÿæˆå¤±æ•—: " + e.message); btn.disabled = false; btn.innerHTML = originalText; 
            }
        }

        // --- Export ---
        function downloadChartImage() {
            const canvas = document.getElementById('hrvChart');
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width; tempCanvas.height = canvas.height;
            tempCtx.fillStyle = '#1e293b'; tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            tempCtx.drawImage(canvas, 0, 0);
            const link = document.createElement('a');
            link.download = 'HRV_Chart.png';
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
        }

        function downloadCSV() {
            if (currentData.length === 0) return alert("æ²’æœ‰æ•¸æ“š");
            const csvContent = "\uFEFF" + "HRV Value\n" + currentData.join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "hrv_data.csv";
            link.click();
        }

        function downloadReport() {
            if (currentData.length === 0) return alert("æ²’æœ‰å ±å‘Š");
            const aiText = document.getElementById('ai-content').innerText;
            let chatHistory = "\n--- èŠå¤©è¨˜éŒ„ ---\n";
            document.querySelectorAll('.chat-msg').forEach(msg => {
                const text = msg.innerText.trim();
                const role = msg.classList.contains('justify-end') ? "æˆ‘: " : "AI: ";
                if (text) chatHistory += `${role}${text}\n`;
            });
            const reportContent = `Hugs & Awake å¥åº·å ±å‘Š\næ™‚é–“: ${new Date().toLocaleString()}\nå¹³å‡ HRV: ${document.getElementById('stat-avg').innerText}\n\nã€åˆ†ææ‘˜è¦ã€‘\n${aiText}\n${chatHistory}`;
            const blob = new Blob(["\uFEFF" + reportContent], { type: "text/plain;charset=utf-8" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "Health_Report.txt";
            link.click();
        }

        // --- Serial ---
        let port, reader, keepReading = false;
        async function connectSerial() {
            if (!("serial" in navigator)) return alert("è«‹ä½¿ç”¨ Chrome ç€è¦½å™¨");
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                document.getElementById('connection-status').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> è£ç½®å·²é€£ç·š';
                document.getElementById('connection-status').className = 'text-xs font-bold text-green-400 flex items-center gap-2';
                document.getElementById('live-panel').classList.remove('hidden');
                keepReading = true;
                readSerialLoop();
            } catch (err) { alert("é€£ç·šå¤±æ•—"); }
        }
        async function readSerialLoop() {
            const textDecoder = new TextDecoderStream();
            port.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();
            let buffer = "";
            try {
                while (keepReading) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    buffer += value;
                    let lines = buffer.split('\n');
                    for (let i = 0; i < lines.length - 1; i++) parseLine(lines[i]);
                    buffer = lines[lines.length - 1];
                }
            } catch (error) {} finally { reader.releaseLock(); }
        }
        function parseLine(line) {
            const hrvMatch = line.match(/HRV:\s*(\d+)/);
            const bpmMatch = line.match(/BPM:\s*(\d+)/);
            if (hrvMatch) {
                const hrv = parseInt(hrvMatch[1]);
                const bpm = bpmMatch ? parseInt(bpmMatch[1]) : "--";
                document.getElementById('live-bpm').innerText = bpm;
                document.getElementById('live-hrv').innerText = hrv;
                document.getElementById('live-message').innerText = `Data: ${line.trim()}`;
                currentData.push(hrv);
                document.getElementById('manual-input').value = currentData.join(', ');
                updateChart(currentData);
                calculateStats(currentData);
            }
        }

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('manual-input').value = e.target.result; processData(); }; reader.readAsText(e.target.files[0]); });
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); const reader = new FileReader(); reader.onload = (e) => { document.getElementById('manual-input').value = e.target.result; processData(); }; reader.readAsText(e.dataTransfer.files[0]); });
    </script>
</body>

</html>
