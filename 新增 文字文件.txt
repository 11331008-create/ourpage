<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hugs & Awake | HRV 雲端數據中心</title>
    
    <!-- 引入必要的外部函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Urbanist:wght@400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        :root {
            --color-bg: #0f172a;
            --color-panel: #1e293b;
            --color-accent: #6366f1;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-bg);
            color: #f8fafc;
        }

        .font-display { font-family: 'Urbanist', sans-serif; }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .file-drop-zone {
            border: 2px dashed #475569;
            transition: all 0.3s ease;
        }
        .file-drop-zone:hover, .file-drop-zone.dragover {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
            background-color: #1e293b; 
            border-radius: 12px;
            padding: 10px;
        }

        .chat-msg { animation: fadeIn 0.3s ease-out; }
        .chat-bubble-ai {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px 12px 12px 2px;
        }
        .chat-bubble-user {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px 12px 2px 12px;
        }

        /* 動畫設定 */
        .audio-bar {
            width: 4px; height: 10px; background-color: #a855f7; border-radius: 2px;
            animation: audioWave 1s infinite ease-in-out;
        }
        .audio-bar:nth-child(2) { animation-delay: 0.1s; height: 15px; }
        .audio-bar:nth-child(3) { animation-delay: 0.2s; height: 20px; }
        .audio-bar:nth-child(4) { animation-delay: 0.3s; height: 12px; }
        
        @keyframes audioWave { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.5); } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pulse-live { animation: pulseLive 2s infinite; }
        @keyframes pulseLive { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- 頂部導航 -->
    <header class="border-b border-white/10 bg-slate-900/50 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center text-white font-bold text-xl">H</div>
                <div>
                    <h1 class="font-display font-bold text-lg leading-tight">Hugs & Awake</h1>
                    <p class="text-xs text-slate-400">HRV 數據分析中心</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="connection-status" class="text-xs font-bold text-red-400 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-red-500"></span> 裝置未連接
                </div>
                <button onclick="connectSerial()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition-all shadow-lg shadow-blue-500/20 flex items-center gap-2">
                    <i class="fa-brands fa-usb"></i> 連接 Arduino
                </button>
            </div>
        </div>
    </header>

    <!-- 主要內容 -->
    <main class="container mx-auto px-6 py-8 flex-1">
        <div class="grid lg:grid-cols-12 gap-8">
            
            <!-- 左欄：輸入與狀態 -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Live Panel -->
                <div class="glass p-6 rounded-2xl border-l-4 border-green-500 hidden" id="live-panel">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-heart-pulse text-green-400 pulse-live"></i> 即時數據
                        </h2>
                        <span class="text-[10px] bg-green-500/20 text-green-400 px-2 py-1 rounded font-mono">LIVE</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-800/80 p-3 rounded-xl text-center">
                            <div class="text-xs text-slate-400 mb-1">BPM (心率)</div>
                            <div id="live-bpm" class="text-3xl font-bold text-white font-display">--</div>
                        </div>
                        <div class="bg-slate-800/80 p-3 rounded-xl text-center">
                            <div class="text-xs text-slate-400 mb-1">HRV (變異)</div>
                            <div id="live-hrv" class="text-3xl font-bold text-blue-400 font-display">--</div>
                        </div>
                    </div>
                    <div id="live-message" class="mt-4 text-xs text-center text-slate-400 font-mono bg-slate-900/50 p-2 rounded">等待訊號...</div>
                </div>

                <!-- Input Card -->
                <div class="glass p-6 rounded-2xl">
                    <h2 class="font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-cloud-arrow-up text-blue-400"></i> 數據輸入
                    </h2>
                    <div id="drop-zone" class="file-drop-zone rounded-xl p-8 text-center cursor-pointer mb-4">
                        <i class="fa-solid fa-file-csv text-3xl text-slate-500 mb-2"></i>
                        <p class="text-sm text-slate-300 font-medium">拖曳 .txt / .csv 至此</p>
                        <input type="file" id="file-input" class="hidden" accept=".txt,.csv">
                    </div>
                    <div class="mb-4">
                        <textarea id="manual-input" class="w-full bg-slate-800/50 border border-slate-700 rounded-lg p-3 text-xs font-mono text-slate-300 focus:border-blue-500 focus:outline-none resize-none h-24" placeholder="或貼上數據: 100, 95, 80..."></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="simulateData()" class="py-2 px-4 rounded-lg border border-slate-600 text-slate-300 text-sm font-bold hover:bg-slate-700 transition-all"><i class="fa-solid fa-dice"></i> 模擬數據</button>
                        <button onclick="processData()" class="py-2 px-4 rounded-lg bg-blue-600 text-white text-sm font-bold hover:bg-blue-500 transition-all shadow-lg shadow-blue-500/20"><i class="fa-solid fa-chart-line"></i> 生成圖表</button>
                    </div>
                </div>

                <!-- Stats -->
                <div id="stats-card" class="glass p-6 rounded-2xl hidden fade-in">
                    <h3 class="font-bold text-white mb-4 text-sm uppercase tracking-wider">數據摘要</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700"><div class="text-xs text-slate-400">平均 HRV</div><div id="stat-avg" class="text-xl font-bold text-white font-mono">--</div></div>
                        <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700"><div class="text-xs text-slate-400">最低 HRV</div><div id="stat-min" class="text-xl font-bold text-red-400 font-mono">--</div></div>
                        <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700"><div class="text-xs text-slate-400">疲勞次數</div><div id="stat-fatigue" class="text-xl font-bold text-blue-400 font-mono">--</div></div>
                        <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700"><div class="text-xs text-slate-400">資料點數</div><div id="stat-time" class="text-xl font-bold text-slate-300 font-mono">--</div></div>
                    </div>
                </div>
            </div>

            <!-- 右欄：圖表與 AI -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Chart -->
                <div class="glass p-6 rounded-2xl border border-slate-700">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-bold text-white text-lg">HRV 趨勢分析圖</h2>
                        <div class="flex gap-2">
                            <button onclick="downloadChartImage()" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold flex items-center gap-2 transition-all">
                                <i class="fa-solid fa-camera"></i> 下載圖表
                            </button>
                            <button onclick="downloadCSV()" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold flex items-center gap-2 transition-all">
                                <i class="fa-solid fa-file-csv"></i> 匯出 CSV
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="hrvChart"></canvas>
                    </div>
                    <div class="flex gap-4 text-xs font-bold mt-4 justify-center">
                        <span class="flex items-center gap-1 text-green-400"><span class="w-2 h-2 rounded-full bg-green-500"></span> 正常 (>80)</span>
                        <span class="flex items-center gap-1 text-red-400"><span class="w-2 h-2 rounded-full bg-red-500"></span> 疲勞/壓力 (<80)</span>
                    </div>
                </div>

                <!-- AI Chat -->
                <div id="ai-card" class="glass p-1 rounded-2xl bg-gradient-to-r from-purple-500/20 to-blue-500/20 border border-purple-500/30 hidden fade-in">
                    <div class="bg-slate-900/90 rounded-xl h-full flex flex-col">
                        <div class="p-6 border-b border-white/5 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-purple-500 flex items-center justify-center text-white"><i class="fa-solid fa-robot"></i></div>
                                <div>
                                    <h3 class="font-bold text-white">Gemini 健康顧問</h3>
                                    <div class="flex items-center gap-2 text-xs text-purple-300"><span><i class="fa-solid fa-volume-high"></i> 支援語音對話</span></div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="generateVoiceAdvice()" id="btn-voice-advice" class="px-3 py-1.5 rounded-full bg-purple-600/20 text-purple-300 text-xs font-bold hover:bg-purple-600 hover:text-white border border-purple-500/30 transition-all flex items-center gap-2">
                                    <i class="fa-solid fa-play"></i> 語音建議
                                </button>
                                <button onclick="downloadReport()" class="px-3 py-1.5 rounded-full bg-green-600/20 text-green-400 text-xs font-bold hover:bg-green-600 hover:text-white border border-green-500/30 transition-all flex items-center gap-2">
                                    <i class="fa-solid fa-file-arrow-down"></i> 下載報告
                                </button>
                            </div>
                        </div>
                        
                        <div id="chat-history" class="p-6 space-y-4 max-h-[300px] overflow-y-auto text-sm text-slate-300">
                            <div class="chat-msg flex gap-3">
                                <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 shrink-0 text-xs"><i class="fa-solid fa-robot"></i></div>
                                <div class="chat-bubble-ai p-3"><p>你好！我是你的 HRV 健康顧問。我可以幫你分析疲勞數據並提供建議。</p></div>
                            </div>
                            <div id="ai-report-container" class="hidden">
                                <div class="chat-msg flex gap-3">
                                    <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 shrink-0 text-xs"><i class="fa-solid fa-file-medical"></i></div>
                                    <div class="chat-bubble-ai p-3 w-full"><div id="ai-content" class="leading-relaxed"></div></div>
                                </div>
                            </div>
                        </div>

                        <div id="audio-container" class="px-6 py-2 hidden">
                            <div class="flex items-center gap-3 bg-purple-500/10 rounded-lg p-3 border border-purple-500/20">
                                <div class="flex gap-1 h-4 items-end"><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div></div>
                                <span class="text-xs text-purple-300 font-mono">語音播放中...</span>
                            </div>
                        </div>

                        <div class="p-4 border-t border-white/5 bg-slate-800/30 rounded-b-xl">
                            <div class="flex gap-2">
                                <input type="text" id="chat-input" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-sm text-white focus:border-purple-500 focus:outline-none" placeholder="輸入問題..." onkeypress="handleKeyPress(event)">
                                <button onclick="askGemini()" id="btn-send" class="bg-purple-600 hover:bg-purple-500 text-white w-10 h-10 rounded-lg flex items-center justify-center transition-all"><i class="fa-solid fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript 邏輯 -->
    <script>
        const apiKey = ""; // API Key

        // --- Chart 設定 ---
        let hrvChart;
        const ctx = document.getElementById('hrvChart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)'); 
        gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)'); 

        hrvChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'HRV (ms)',
                    data: [],
                    borderColor: '#6366f1',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3,
                    pointBackgroundColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' }, suggestedMax: 150 },
                    x: { grid: { display: false }, ticks: { display: false } }
                }
            }
        });

        // --- 核心變數 ---
        let currentData = [];

        // --- 數據處理 ---
        function processData() {
            const rawText = document.getElementById('manual-input').value;
            const dataPoints = rawText.trim() ? rawText.split(/[\s,]+/).map(Number).filter(n => !isNaN(n) && n > 0) : [];
            currentData = dataPoints;
            if (dataPoints.length > 0) {
                updateChart(dataPoints);
                calculateStats(dataPoints);
                document.getElementById('stats-card').classList.remove('hidden');
                document.getElementById('ai-card').classList.remove('hidden');
                // 只有第一次自動分析
                if(document.getElementById('ai-content').innerText === "") {
                    analyzeWithAI();
                }
            }
        }

        function updateChart(data) {
            const labels = data.map((_, i) => `T${i}`);
            const viewData = data.slice(-50); 
            const viewLabels = labels.slice(-50);
            hrvChart.data.labels = viewLabels;
            hrvChart.data.datasets[0].data = viewData;
            // 變色邏輯
            const pointColors = viewData.map(v => v < 80 ? '#ef4444' : '#fff');
            hrvChart.data.datasets[0].pointBackgroundColor = pointColors;
            hrvChart.data.datasets[0].pointBorderColor = pointColors;
            hrvChart.update();
        }

        function calculateStats(data) {
            if (data.length === 0) return;
            const avg = Math.round(data.reduce((a, b) => a + b, 0) / data.length);
            const min = Math.min(...data);
            const fatigueCount = data.filter(v => v < 80).length;
            document.getElementById('stat-avg').innerText = avg + " ms";
            document.getElementById('stat-min').innerText = min + " ms";
            document.getElementById('stat-fatigue').innerText = fatigueCount + " 次";
            document.getElementById('stat-time').innerText = data.length;
        }

        function simulateData() {
            let data = [];
            let val = 100;
            for(let i=0; i<50; i++) {
                val += (Math.random() * 20 - 10);
                if(i > 20 && i < 35) val -= 5;
                if(i > 35) val += 5;
                if(val > 150) val = 150;
                if(val < 30) val = 30;
                data.push(Math.round(val));
            }
            document.getElementById('manual-input').value = data.join(', ');
            processData();
        }

        // --- AI 聊天 ---
        function handleKeyPress(e) { if (e.key === 'Enter') askGemini(); }

        async function askGemini() {
            const inputEl = document.getElementById('chat-input');
            const question = inputEl.value.trim();
            if (!question) return;
            addChatMessage(question, 'user');
            inputEl.value = '';
            const loadingId = addChatMessage("思考中...", 'ai', true);

            try {
                const dataStr = currentData.slice(-20